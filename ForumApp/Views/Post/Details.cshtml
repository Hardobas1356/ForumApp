@using ForumApp.GCommon.Enums
@using ForumApp.Web.ViewModels.Post
@using static ForumApp.GCommon.Enums.SortEnums.ReplySort
@model PostDetailsViewModel

@{
	ReplySortBy currentReplySort = ViewBag.ReplySortBy != null
		? (ReplySortBy)ViewBag.ReplySortBy
		: ReplySortBy.Default;
}

<div class="container mt-4">
	<div class="mb-3">
		<a asp-controller="Board"
		   asp-action="Details"
		   asp-route-id="@Model.BoardId"
		   class="btn btn-outline-secondary btn-sm">
			<i class="fas fa-arrow-left me-1"></i> Back to "@Model.BoardName"
		</a>
	</div>
	
	@if (Model.Tags != null && Model.Tags.Any())
	{
		<div class="mb-2">
			@foreach (var tag in Model.Tags)
			{
				<span class="badge me-1"
					  style="background-color:@tag.ColorHex; color:@(tag.ColorHex.ToLower() == "#ffffff" ? "#000" : "#fff");">
					@tag.Name
				</span>
			}
		</div>
	}
	<div class="text-muted mb-1">
		<small>Posted in: <strong>@Model.BoardName</strong></small>
	</div>
	<h2 class="mb-2">@Model.Title</h2>

	<div class="d-flex align-items-center text-muted mb-3 gap-2">
		<img src="@Model.AuthorImageUrl" alt="@Model.Author" 
			 class="rounded-circle" 
			 style="width:24px; height:24px; object-fit:cover;" loading="lazy" />
		<span><i class="far fa-user me-1"></i>@Model.Author</span>
		<span>|</span>
		<span><i class="far fa-calendar-alt me-1"></i>Created: @Model.CreatedAt</span>
		@if (Model.ModifiedAt != Model.CreatedAt)
		{
			<span class="ms-3"><i class="fas fa-edit me-1"></i>Modified: @Model.ModifiedAt</span>
		}
	</div>

	@if (!string.IsNullOrWhiteSpace(Model.ImageUrl))
	{
		<div class="mb-3 text-center">
			<img src="@Model.ImageUrl"
				 alt="Post image"
				 class="img-fluid rounded shadow-sm"
				 style="max-height: 400px;" />
		</div>
	}

	<div class="position-relative mb-4 p-3 rounded bg-white @(Model.IsPinned ? "border border-success border-3" : "border border-secondary")">
		@if (Model.IsPinned)
		{
			<span class="badge bg-success position-absolute top-0 end-0 m-2">
				📌 Pinned
			</span>
		}
		<p class="text-break mb-0">@Model.Content</p>
	</div>

	@if (User?.Identity?.IsAuthenticated == true)
	{
		<div class="mb-4">
			@if (Model.IsPublisher)
			{
				<a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning me-2">
					<i class="fas fa-edit me-1"></i>Edit
				</a>
			}
			@if (Model.CanModerate || Model.IsPublisher)
			{
				<a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
					<i class="fas fa-trash-alt me-1"></i>Delete
				</a>
			}
			@if (Model.CanModerate)
			{
				if (Model.IsPinned)
				{
				<form asp-controller="Post" asp-action="Unpin" method="post" class="d-inline">
					@Html.AntiForgeryToken()
					<input type="hidden" name="id" value="@Model.Id" />
					<button type="submit" class="btn btn-warning">
						<i class="fas fa-thumbtack me-1"></i>Unpin Post
					</button>
				</form>
				}
				else
				{
				<form asp-controller="Post" asp-action="Pin" method="post" class="d-inline">
					@Html.AntiForgeryToken()
					<input type="hidden" name="id" value="@Model.Id" />
					<button type="submit" class="btn btn-success">
						<i class="fas fa-thumbtack me-1"></i>Pin Post
					</button>
				</form>
				}
			}
		</div>
	}
	<hr />

	<div class="d-flex align-items-center mb-2">
		<h4 class="mb-0 me-3">Replies</h4>

		<form method="get" asp-action="Details" class="d-flex align-items-center" style="white-space: nowrap;">
			<input type="hidden" name="id" value="@Model.Id" />
			<label for="replySort" class="me-2 mb-0" style="white-space: nowrap;">Sort Replies:</label>
			<select id="replySort" name="sortBy" class="form-select form-select-sm" onchange="this.form.submit()">
				@foreach (ReplySortBy sortOption in Enum.GetValues(typeof(ReplySortBy)))
				{
					<option value="@sortOption" selected="@(sortOption == currentReplySort)">
						@sortOption.ToString().Replace("Ascending", " ↑").Replace("Descending", " ↓")
					</option>
				}
			</select>
			<noscript><button type="submit" class="btn btn-sm btn-primary ms-2">Sort</button></noscript>
		</form>

		@if (User?.Identity?.IsAuthenticated == true)
		{
			<a asp-controller="Reply"
			   asp-action="Create"
			   asp-route-postId="@Model.Id"
			   class="btn btn-primary ms-3">
				<i class="fas fa-reply me-1"></i>Add Reply
			</a>
		}
	</div>

	@if (Model.Replies == null || !Model.Replies.Items.Any())
	{
		<p class="fst-italic text-muted">No replies in this post yet.</p>
	}
	else
	{
		<ul class="list-group">
			@foreach (var reply in Model.Replies.Items)
			{
				<li class="list-group-item">
					<div class="d-flex justify-content-between align-items-start flex-wrap">
						<div class="me-2">
							<div class="d-flex align-items-center gap-2 mb-2">
								<img src="@reply.AuthorImageUrl" alt="@reply.Author" 
									 class="rounded-circle" 
									 style="width:24px; height:24px; object-fit:cover;" loading="lazy" />
								<small class="text-muted">By @reply.Author at @reply.CreatedAt</small>
							</div>
							<div class="reply-content text-break">@reply.Content</div>
						</div>
						@if (User?.Identity?.IsAuthenticated == true && (reply.IsPublisher || reply.CanModerate))
						{
							<div class="btn-group" role="group">
								@if (reply.IsPublisher)
								{
									<a asp-controller="Reply"
									   asp-action="Edit"
									   asp-route-id="@reply.Id"
									   asp-route-postId="@Model.Id"
									   class="btn btn-sm btn-warning">Edit</a>
								}
								@if (reply.CanModerate || reply.IsPublisher)
								{
									<a asp-controller="Reply"
									   asp-action="Delete"
									   asp-route-id="@reply.Id"
									   asp-route-postId="@Model.Id"
									   class="btn btn-sm btn-danger">Delete</a>
								}
							</div>
						}
					</div>
				</li>
			}
		</ul>

		@await Html.PartialAsync("_Pagination",Model.Replies);
	}
</div>
