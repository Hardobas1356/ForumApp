@using ForumApp.GCommon.Enums
@using ForumApp.Web.ViewModels.Admin.Board
@using static ForumApp.GCommon.Enums.SortEnums.Post
@model BoardDetailsAdminViewModel

@{
	ViewData["Title"] = "Board Admin Details";
	PostSortBy currentSort = ViewBag.SortBy as PostSortBy? ?? PostSortBy.Default;
}

<div class="container py-4">
	<div class="d-flex justify-content-between align-items-center mb-3">
		<div class="d-flex align-items-center">
			@if (!string.IsNullOrWhiteSpace(Model.ImageUrl))
			{
				<img src="@Model.ImageUrl"
					 alt="Board icon"
					 class="rounded me-2"
					 style="height: 40px; width: 40px; object-fit: cover;" />
			}
			<h2 class="mb-0">
				<i class="fas fa-shield-alt me-2"></i>@Model.Name
			</h2>
		</div>
		<a asp-area="Admin" asp-controller="Board" asp-action="Index" class="btn btn-outline-secondary">
			<i class="fas fa-arrow-left me-1"></i>Back to All Boards
		</a>
	</div>

	<div class="mb-4">
		<h5>Description:</h5>
		<p>@Model.Description</p>
	</div>

	@if (Model.Categories?.Any() == true)
	{
		<div class="mb-4">
			<h5>Categories</h5>
			@foreach (var category in Model.Categories)
			{
				<span class="badge me-1"
					  style="background-color: @category.ColorHex; color: @(category.ColorHex.ToLower() == "#ffffff" ? "#000" : "#fff");">
					@category.Name
				</span>
			}
		</div>
	}

	<div class="mb-4">
		<h5>Moderators</h5>

		@if (Model.Moderators?.Any() == true)
		{
			<ul class="list-group">
				@foreach (var mod in Model.Moderators)
				{
					<li class="list-group-item d-flex justify-content-between align-items-center">
						<div>
							<strong>@mod.DisplayName</strong>
							<span class="text-muted">(@mod.Handle)</span>
						</div>
						<form asp-area="Admin" asp-controller="Moderator" asp-action="RemoveModerator" method="post" class="d-inline">
							<input type="hidden" name="boardId" value="@Model.Id" />
							<input type="hidden" name="userId" value="@mod.Id" />
							<button type="submit" class="btn btn-sm btn-outline-danger">
								<i class="fas fa-user-minus me-1"></i>Remove
							</button>
						</form>
					</li>
				}
			</ul>
		}
		else
		{
			<div class="alert alert-info">No moderators yet.</div>
		}

		<div class="mt-3">
			<form asp-area="Admin" 
			asp-controller="Moderator" 
			asp-action="SearchUsers" 
			method="get"
			class="d-flex gap-2">
				<input type="hidden" name="boardId" value="@Model.Id" />
				<input type="text" name="handle" class="form-control"
					placeholder="Search by @@handle..." />
				<button type="submit" class="btn btn-outline-primary">
					<i class="fas fa-search me-1"></i>Search
				</button>
			</form>
		</div>
		@if (Model.SearchPerformed)
		{
			if (Model.SearchResults != null && Model.SearchResults.Any())
			{
				<div class="mt-4">
					<h5>Search Results</h5>
							@if (Model.SearchResults.Count() == 10)
							{
								<div class="alert alert-info">
									<i class="fas fa-info-circle me-1"></i>
									Showing first 10 results. Use more specific search terms to refine results.
								</div>
							}
					<ul class="list-group">
						@foreach (var user in Model.SearchResults)
						{
							<li class="list-group-item d-flex justify-content-between align-items-center">
								<div>
									<strong>@user.DisplayName</strong>
									<span class="text-muted">(@user.UserName)</span>
								</div>
								@if (user.IsModerator)
								{
									<form asp-area="Admin" asp-controller="Moderator" asp-action="RemoveModerator" method="post" class="d-inline">
										<input type="hidden" name="boardId" value="@Model.Id" />
										<input type="hidden" name="userId" value="@user.Id" />
										<button type="submit" class="btn btn-sm btn-outline-danger">
											<i class="fas fa-user-minus me-1"></i>Remove
										</button>
									</form>
								}
								else
								{
									<form asp-area="Admin" asp-controller="Moderator" asp-action="AddModerator" method="post" class="d-inline">
										<input type="hidden" name="boardId" value="@Model.Id" />
										<input type="hidden" name="userId" value="@user.Id" />
										<button type="submit" class="btn btn-sm btn-outline-success">
											<i class="fas fa-user-plus me-1"></i>Add
										</button>
									</form>
								}
							</li>
						}
					</ul>
				</div>
			}
			else
			{
				<div class="alert alert-warning mt-3">
					No users found matching your search.
				</div>
			}
		}
	</div>

	<div class="mb-4">
		<h5>Posts</h5>

		<form asp-area="Admin"
			  asp-controller="Board"
			  asp-action="Details"
			  asp-route-id="@Model.Id"
			  method="get"
			  class="mb-3 d-flex justify-content-end align-items-center">

			<label class="me-2 fw-semibold mb-0">Sort by:</label>

			<select name="sortBy"
					class="form-select w-auto"
					onchange="this.form.submit()">
				@foreach (PostSortBy sortOption in Enum.GetValues(typeof(PostSortBy)))
				{
					<option value="@sortOption" selected="@(sortOption == currentSort)">
						@sortOption.ToString().Replace("Ascending", " ↑").Replace("Descending", " ↓")
					</option>
				}
			</select>
		</form>

		@if (Model.Posts?.Items.Any() == true)
		{
			<ul class="list-group">
				@foreach (var post in Model.Posts.Items)
				{
					<li class="list-group-item">
						<strong>@post.Title</strong> —
						<span class="text-muted">by @post.Author (@post.Handle)</span><br />
						<small class="text-muted">Posted: @post.CreatedAt</small>
					</li>
				}
			</ul>

			
			@await Html.PartialAsync("_Pagination", Model.Posts)
		}
		else
		{
			<div class="alert alert-secondary">No posts in this board yet.</div>
		}
	</div>
</div>

